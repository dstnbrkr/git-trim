#!/bin/sh

all=.git-trim-all
keep=.git-trim-keep

cleanup() {
  rm $all $keep
}

branches=`git branch`

if [ $? != 0 ]; then
  exit 1
fi

if [[ ! $EDITOR ]]; then
  EDITOR=vim
fi

echo "$branches" | grep -v '^*' | sed 's/^  //' | tee $all $keep > /dev/null

if [ `cat $all | wc -l` == 0 ]; then
  echo "No branches found to delete (cannot delete current branch)."
  cleanup
  exit 0
fi

cat >> $keep << EOF

#  Remove the branches you would like to delete.

EOF

eval $EDITOR $keep

if [ $? != 0 ]; then
  echo "Unable to open editor '$EDITOR'. Check value of \$EDITOR and try again."
  cleanup
  exit 1
fi

delete=`diff --suppress-common-lines $all $keep | grep '^< ' | awk '{print $2}'`

echo $delete | xargs git branch -D

cleanup

